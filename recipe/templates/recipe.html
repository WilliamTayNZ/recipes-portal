{% extends "base.html" %}
{% block title %}{{ recipe.name }}{% endblock %}
{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/recipe.css') }}">

    <main class="recipe-container">
        <span id="close"></span>
        <!-- Recipe Header -->
        <div class="recipe-header">
            <h3 class="recipe-category">{{ recipe.category.name if recipe.category else "Uncategorized" }}</h3>
            <h1 class="recipe-title">{{ recipe.name.upper() }}</h1>
            <p class="recipe-author">By {{ recipe.author.name if recipe.author else "Unknown Author" }}</p>
            <p class="recipe-description">{{ recipe.description if recipe.description else "No description available." }}</p>
        </div>

        <!-- Main Content Area -->
        <div class="recipe-content">
            <!-- Left Side - Image Gallery -->
            <div class="image-gallery">
                <div class="gallery-header">
                    {% set from_param = request.args.get('from') %}
                    {% if from_param == 'favourites' %}
                        <a href="{{ url_for('browse_bp.favourites') }}" class="back-link">&lt; Return to favourites</a>
                    {% else %}
                        <a href="{{ url_for('browse_bp.browse') }}" class="back-link">&lt; Back to recipes</a>
                    {% endif %}

                </div>
                
                <div class="main-image-container">
                    <div class="main-image">
                        {% set first_image = recipe.images[0] if recipe.images else url_for('static', filename='assets/usagi.png') %}
                        <a href="#img-0">
                            <img src="{{ first_image }}" alt="{{ recipe.name }}" class="current-image">
                        </a>
                    </div>
                </div>

                <div class="thumbnail-container">
                    {% if recipe.images %}
                        {% for image in recipe.images %}
                            <a href="#img-{{ loop.index0 }}">
                                <img src="{{ image }}" alt="{{ recipe.name }}" class="thumbnail">
                            </a>
                        {% endfor %}
                    {% else %}
                        <a href="#img-0">
                            <img src="{{ url_for('static', filename='assets/usagi.png') }}" alt="{{ recipe.name }}" class="thumbnail active">
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Right Side - Recipe Details -->
            <div class="recipe-details">
                <!-- Time and Date Info -->
                <div class="info-boxes">
                    <div class="info-box">
                        <span class="info-label">PREP TIME</span>
                        <span class="info-value">{{ recipe.preparation_time }} seconds</span>
                    </div>
                    <div class="info-box">
                        <span class="info-label">COOK TIME</span>
                        <span class="info-value">{{ recipe.cook_time }} seconds</span>
                    </div>
                    <div class="info-box">
                        <span class="info-label">PUBLISHED</span>
                        <span class="info-value">{{ recipe.date.strftime('%d{} %b %Y'.format('th' if 10 <= recipe.date.day % 100 <= 20 else {1: 'st', 2: 'nd', 3: 'rd'}.get(recipe.date.day % 10, 'th'))) if recipe.date else "Not specified" }}</span>
                    </div>
                </div>

                <!-- Ingredients -->
                <div class="ingredients-section">
                    <h3 class="section-title">INGREDIENTS</h3>
                    <div class="ingredients-list">
                        {% if recipe.ingredients and recipe.ingredient_quantities %}
                            {% for i in range(recipe.ingredients|length) %}
                                <div class="ingredient-item">
                                    {% if i < recipe.ingredient_quantities|length %}
                                        <span class="quantity">{{ recipe.ingredient_quantities[i] }}</span>
                                    {% endif %}
                                    <span class="ingredient">{{ recipe.ingredients[i] }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p>No ingredients available.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Instructions Section -->
                <div class="instructions-section">
                    <h3 class="section-title">INSTRUCTIONS</h3>
                    <div class="instructions-list">
                        {% if recipe.instructions %}
                            {% for instruction in recipe.instructions %}
                                <div class="instruction-step">
                                    <span class="step-number">{{ loop.index }}.</span>
                                    <span class="step-text">{{ instruction }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p>No instructions available.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Nutritional Information -->
        <div class="nutrition-section">
            <h3 class="section-title">NUTRITIONAL INFORMATION (PER SERVING)</h3>
            {% if recipe.nutrition %}
                <div class="nutrition-grid">
                    <div class="nutrition-item">
                        <span class="nutrition-label">Calories</span>
                        <span class="nutrition-value">{{ recipe.nutrition.calories }} kcal</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="nutrition-label">Fat</span>
                        <span class="nutrition-value">{{ recipe.nutrition.fat }} g</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="nutrition-label">Saturated Fat</span>
                        <span class="nutrition-value">{{ recipe.nutrition.saturated_fat }} g</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="nutrition-label">Cholesterol</span>
                        <span class="nutrition-value">{{ recipe.nutrition.cholesterol }} mg</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="nutrition-label">Sodium</span>
                        <span class="nutrition-value">{{ recipe.nutrition.sodium }} mg</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="nutrition-label">Carbohydrates</span>
                        <span class="nutrition-value">{{ recipe.nutrition.carbohydrates }} g</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="nutrition-label">Fiber</span>
                        <span class="nutrition-value">{{ recipe.nutrition.fiber }} g</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="nutrition-label">Sugar</span>
                        <span class="nutrition-value">{{ recipe.nutrition.sugar }} g</span>
                    </div>
                    <div class="nutrition-item">
                        <span class="nutrition-label">Protein</span>
                        <span class="nutrition-value">{{ recipe.nutrition.protein }} g</span>
                    </div>
                </div>
                <div class="recipe-servings">
                    <div class="servings-item">
                        <span class="servings-label">Recipe Servings</span>
                        <span class="servings-value">{{ recipe.servings if recipe.servings else "Not specified" }}</span>
                    </div>
                    <div class="servings-item">
                        <span class="servings-label">Recipe Yield</span>
                        <span class="servings-value">{{ recipe.recipe_yield if recipe.recipe_yield else "Not specified" }}</span>
                    </div>
                </div>
            {% else %}
                <p>No nutritional information available.</p>
            {% endif %}
        </div>
    </main>

    {% if recipe.images %}
        {% for image in recipe.images %}
            <div class="image-modal" id="img-{{ loop.index0 }}">
                <a href="#close" class="modal-backdrop" aria-label="Close"></a>
                <div class="modal-content">
                    <img src="{{ image }}" alt="{{ recipe.name }}">
                    {% if recipe.images|length > 1 %}
                        {% set prev_idx = (loop.index0 - 1) % recipe.images|length %}
                        {% set next_idx = (loop.index0 + 1) % recipe.images|length %}
                        <a href="#img-{{ prev_idx }}" class="modal-nav-arrow left-arrow" aria-label="Previous">&lt;</a>
                        <a href="#img-{{ next_idx }}" class="modal-nav-arrow right-arrow" aria-label="Next">&gt;</a>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="image-modal" id="img-0">
            <a href="#close" class="modal-backdrop" aria-label="Close"></a>
            <div class="modal-content">
                <img src="{{ url_for('static', filename='assets/usagi.png') }}" alt="{{ recipe.name }}">
            </div>
        </div>
    {% endif %}

{% endblock %}