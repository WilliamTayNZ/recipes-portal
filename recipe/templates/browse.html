{% extends "base.html" %}
{% block title %}Browse{% endblock %}
{% block content %}
    <div class="heading-cont">
        <h2>{{ "MY FAVOURITES" if mode == "favourites" else "BROWSE RECIPES!" }}</h2>

        <form method="GET"
              action="{{ url_for('browse_bp.favourites') if mode == 'favourites' else url_for('browse_bp.browse') }}"
              class="search-bar">
            <select name="filter_by">
                <option value="name" {% if filter_by == 'name' %}selected{% endif %}>Recipe Name</option>
                <option value="category" {% if filter_by == 'category' %}selected{% endif %}>Category</option>
                <option value="author" {% if filter_by == 'author' %}selected{% endif %}>Author</option>
                <option value="ingredient" {% if filter_by == 'ingredient' %}selected{% endif %}>Ingredient</option>
            </select>

            <input type="text" name="query" placeholder="Search recipes..." value="{{ query or '' }}" required />

            <button type="submit">Search</button>
        </form>
    </div>

    <div class="recipes-cont">
        {% for recipe in recipes %}
            <div class="browse-card">
                <div class="browse-card-cont" onclick="location.href='/recipe/{{ recipe.id }}'">
                    <img src="{{ recipe.images[0] }}" alt="recipe-image">
                </div>
                <h1>{{ recipe.name }}</h1>
                <p>{{ recipe.description }}</p>

                {% if session.get('user_name') %}
                    <button type="button" class="fav-btn{% if recipe.is_favourite %} favorited{% endif %}" data-recipe-id="{{ recipe.id }}">
                        <span class="heart">{{ "♥" if recipe.is_favourite else "♡" }}</span>
                    </button>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <div class="pagination">
        {% if prev_recipe_url %}
            <a href="{{ prev_recipe_url }}">&laquo;</a> <!-- Single Left -->
        {% endif %}
        {% if first_recipe_url %}
            <a href="{{ first_recipe_url }}">&lt;</a> <!-- Double Left -->
        {% endif %}
        {% if next_recipe_url %}
            <a href="{{ next_recipe_url }}">&gt;</a> <!-- Single Right -->
        {% endif %}
        {% if last_recipe_url %}
            <a href="{{ last_recipe_url }}">&raquo;</a> <!-- Double Right -->
        {% endif %}
    </div>


    # update the favourite button and text, upon clicking the button
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const favButtons = document.querySelectorAll('.fav-btn');
            
            favButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent card click
                    
                    const recipeId = this.getAttribute('data-recipe-id');
                    const heart = this.querySelector('.heart');
                    
                    // Make AJAX request
                    fetch(`/favourites/${recipeId}/toggle`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Toggle the visual state
                            if (data.is_favourite) {
                                this.classList.add('favorited');
                                heart.textContent = '♥';
                            } else {
                                this.classList.remove('favorited');
                                heart.textContent = '♡';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error toggling favourite:', error);
                    });
                });
            });
        });
    </script>

{% endblock %}